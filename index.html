<html>
  <head>
    <!-- import js davinci api 
          https://apidocs.contactcanvas.com/index.html
          https://apidocs.contactcanvas.com/modules/davinci_api.html
          https://www.npmjs.com/package/@amc-technology/davinci-api?activeTab=versions
        -->
    <script src="davinci-api-1-0-41.js"></script>
    <title>Interceptor App</title>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script>
      console.log("HTTP Server Josh P");
      // Initialize the logger function. This is optional, as AMC uses these logs to troubleshoot
      // and debug customer issues.
      var logger = new amcTechnologydavinciApi.Logger("CCBA Interceptor");

      // Register for intercepting Events. In this case it's intercepting Interaction event
      amcTechnologydavinciApi.registerOperationInterceptor(
        [amcTechnologydavinciApi.OPERATIONS.INTERACTION],
        async (payload) => {
          if (payload.didTimeout) {
            console.log("TIMEOUT INTERCEPTOR");
          } else {
            payload = handleInteraction(payload);
          }

          return payload;
        },
        5000,
        amcTechnologydavinciApi.INTERCEPTOR_TIMEOUT_ACTION.PROCEED_WITH_ORIGINAL
      );

      function handleInteraction(payload) {
        try {
          let interaction = isResponse(payload.message)
            ? payload.message.request.data[0]
            : payload.message.data[0];

          // if isDialerPreview is true but has no account number, suppress the interaction event.
          if (
            interaction.state === amcTechnologydavinciApi.INTERACTION_STATES.Alerting &&
            interaction.details?.fields?.isDialerPreview?.Value &&
            (!interaction.details.fields.accountnumber ||
              !interaction.details.fields.accountnumber.Value)
          ) {
            return;
          }
        } catch (e) {
          alert(JSON.stringify(e));
        }
        return payload;
      }

      function isResponse(message) {
        return message.isResponse != null && message.isResponse === true;
      }

      amcTechnologydavinciApi
        .initializeComplete(logger)
        .then(function (config) {
          amcTechnologydavinciApi.setAppHeight(0);
        });
    </script>
  </head>
  <body></body>
</html>
